<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JSON Viewer — Issuers / Cards / Promotions</title>
  <style>
    :root{
      --bg: #0b0c0f;
      --card: #12151a;
      --muted: #9aa4b2;
      --text: #e6e9ef;
      --border: #1f2430;
      --accent: #7c9cff;
      --accent-2: #59e1ff;
      --badge-bg: #19202b;
      --badge-br: #2a3342;
      --row: #0f1217;
      --row-alt: #10151c;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f8fb; --card:#ffffff; --muted:#6b7280; --text:#0f172a; --border:#e5e7eb;
        --accent:#3b82f6; --accent-2:#06b6d4; --badge-bg:#f1f5f9; --badge-br:#e2e8f0;
        --row:#ffffff; --row-alt:#fafafa; --shadow:0 8px 24px rgba(2,6,23,0.08);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
      Roboto, "Noto Sans", "PingFang HK", "Hiragino Sans", Arial, sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, rgba(124,156,255,.10), transparent 60%),
                  radial-gradient(1200px 900px at 110% 10%, rgba(89,225,255,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:28px 20px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px
    }
    .title{font-size:22px;font-weight:700;letter-spacing:.2px}
    .muted{color:var(--muted);font-size:12px}
    .search{
      min-width:240px; max-width:420px; flex:1;
      padding:10px 12px; border:1px solid var(--border); border-radius:12px;
      background:linear-gradient(0deg,rgba(255,255,255,.02),rgba(255,255,255,.02)),var(--card);
      color:var(--text); outline:none;
    }
    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .select{min-width:260px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:linear-gradient(0deg,rgba(255,255,255,.02),rgba(255,255,255,.02)),var(--card);color:var(--text);outline:none}
    .btn-clear{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);cursor:pointer}
    .btn-clear:active{transform:translateY(1px)}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{border:1px solid var(--border);background:var(--card);color:var(--text);padding:6px 10px;border-radius:999px;cursor:pointer;font-size:12px}
    .chip[aria-pressed="true"]{outline:2px solid var(--accent); background:linear-gradient(0deg,rgba(255,255,255,.04),rgba(255,255,255,.04)),var(--card)}
    .chip:active{transform:translateY(1px)}
    .grid{
      display:grid; grid-template-columns:1fr; gap:18px;
    }
    /* @media(min-width:900px){ .grid{ grid-template-columns:1fr 1fr; } } */
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)) , var(--card);
      border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:15px;cursor:pointer;position:relative}
    .card h2::after{content:"▾";position:absolute;right:12px;top:50%;transform:translateY(-50%) rotate(0deg);transition:transform .15s ease-in-out;color:var(--muted)}
    .card[data-collapsed="true"] h2::after{transform:translateY(-50%) rotate(-90deg)}
    /* Hide card body when collapsed */
    .card[data-collapsed="true"] .inner, .card[data-collapsed="true"] .scroll{display:none}
    .card .inner{padding:10px 12px}
    .scroll{max-height:55vh;overflow:auto;border-top:1px solid var(--border)}
    table{width:100%; border-collapse:separate; border-spacing:0; font-size:12.5px}
    thead th{
      position:sticky; top:0; z-index:2; background:var(--card);
      border-bottom:1px solid var(--border); text-align:left; padding:10px 12px;
      font-weight:600;
    }
    tbody td{padding:10px 12px; border-bottom:1px dashed var(--border); vertical-align:top}
    tbody tr:nth-child(odd){background:var(--row)}
    tbody tr:nth-child(even){background:var(--row-alt)}
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
         font-size:12px; padding:.1rem .35rem; border-radius:6px; background:var(--badge-bg); border:1px solid var(--badge-br)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:6px;
          background:var(--badge-bg); border:1px solid var(--badge-br); margin:2px 4px 2px 0}
    .subtle{opacity:.85}
    .footer{margin-top:18px; text-align:right}
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">JSON Viewer</div>
      <input id="q" class="search" placeholder="Search cards & promotions…" />
    </div>
    <div class="muted" style="margin-bottom:14px">Loads <code>issuer.json</code>, <code>card.json</code>, and <code>promotion.json</code> from this folder.</div>

    <div class="grid">
      <div class="card" data-collapsed="true">
        <h2>Issuers <span id="issuer-count" class="muted"></span></h2>
        <div class="scroll"><table id="tbl-issuers"></table></div>
      </div>

      <div class="card" data-collapsed="true">
        <h2>Cards <span id="card-count" class="muted"></span></h2>
        <div class="inner hint">Showing fields as columns; arrays render as badges.</div>
        <div class="scroll"><table id="tbl-cards"></table></div>
      </div>

      <div class="card">
        <h2>Promotions <span id="promo-count" class="muted"></span></h2>
        <div class="inner filters">
          <label class="muted">Merchant type:</label>
          <div id="merchant-chips" class="chips"></div>
          <button id="merchant-clear" class="btn-clear" type="button">Clear</button>
          <span class="hint">Tap chips to toggle</span>
        </div>
        <div class="inner hint">Quick filter above searches across text in both tables.</div>
        <div class="scroll"><table id="tbl-promos"></table></div>
      </div>
    </div>

    <div class="footer muted" id="meta"></div>
  </div>

  <script>
    const state = { issuers: [], cards: [], promos: [], filteredCards: [], filteredPromos: [] };

    async function load(path){
      const res = await fetch(path, { cache: "no-store" });
      if(!res.ok) throw new Error(`${path}: ${res.status} ${res.statusText}`);
      return res.json();
    }

    function caps(s){ return (s||"").charAt(0).toUpperCase() + (s||"").slice(1); }

    function valueToHTML(v){
      if (v == null) return "";
      if (Array.isArray(v)) {
        if (v.length === 0) return "";
        return v.map(x => `<span class="pill">${escapeHTML(String(x))}</span>`).join("");
      }
      if (typeof v === "object") return `<code>${escapeHTML(JSON.stringify(v))}</code>`;
      const s = String(v);
      // highlight IDs like ABC1234
      if (/^[A-Z0-9]{6,}$/.test(s)) return `<code>${escapeHTML(s)}</code>`;
      return escapeHTML(s);
    }

    function normalizeType(s){
      return String(s||"").toLowerCase().replace(/\s+/g, "");
    }
    function isAnySpendingLabel(s){
      const t = normalizeType(s);
      return t.includes("anyspending") || t.includes("任何消費");
    }
    function promoHasAnySpending(p){
      const arr = Array.isArray(p.merchantType) ? p.merchantType : [];
      return arr.some(isAnySpendingLabel);
    }

    function renderTable(el, rows){
      if (!rows || rows.length === 0) {
        el.innerHTML = "<tbody><tr><td class='subtle'>No data</td></tr></tbody>";
        return;
      }
      // Collect columns across all rows for stability
      const cols = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
      const thead = "<thead><tr>" + cols.map(c => `<th>${escapeHTML(caps(c))}</th>`).join("") + "</tr></thead>";
      const tbody = "<tbody>" + rows.map(r => {
        return "<tr>" + cols.map(c => `<td>${valueToHTML(r[c])}</td>`).join("") + "</tr>";
      }).join("") + "</tbody>";
      el.innerHTML = thead + tbody;
    }

    function escapeHTML(s){
      return s.replace(/[&<>"']/g, ch => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[ch]));
    }

    function buildMerchantOptions(promos){
      const all = new Set();
      promos.forEach(p => {
        (Array.isArray(p.merchantType) ? p.merchantType : []).forEach(mt => {
          const key = mt && String(mt).trim();
          if(key) all.add(key);
        });
      });
      const list = Array.from(all).sort((a,b)=>String(a).localeCompare(String(b)));
      const box = document.getElementById('merchant-chips');
      box.innerHTML = '';
      list.forEach(txt => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'chip';
        btn.setAttribute('aria-pressed', 'false');
        btn.dataset.value = txt;
        btn.textContent = txt;
        box.appendChild(btn);
      });
    }
    function getSelectedMerchantTypes(){
      return Array.from(document.querySelectorAll('#merchant-chips .chip[aria-pressed="true"]')).map(el => el.dataset.value);
    }

    function applyFilters(){
      const s = (document.getElementById('q').value || '').trim().toLowerCase();
      const chosen = getSelectedMerchantTypes().map(normalizeType);

      // Cards filter (text only)
      state.filteredCards = !s ? state.cards : state.cards.filter(r => JSON.stringify(r).toLowerCase().includes(s));

      // Promotions filter (text + merchant types)
      let base = !s ? state.promos : state.promos.filter(r => JSON.stringify(r).toLowerCase().includes(s));

      if(chosen.length){
        base = base.filter(p => {
          if (promoHasAnySpending(p)) return true; // Any Spending matches all
          const types = (Array.isArray(p.merchantType) ? p.merchantType : []).map(normalizeType);
          return chosen.some(c => types.includes(c));
        });
      }

      base.sort((a,b)=> (Number(b.rebatePercentageCashback)||0) - (Number(a.rebatePercentageCashback)||0));

      state.filteredPromos = base;
      renderTable(document.getElementById('tbl-cards'), state.filteredCards);
      renderTable(document.getElementById('tbl-promos'), state.filteredPromos);
      setCounts();
    }

    function setCounts(){
      document.getElementById("issuer-count").textContent = `(${state.issuers.length})`;
      document.getElementById("card-count").textContent   = `(${state.filteredCards.length}/${state.cards.length})`;
      document.getElementById("promo-count").textContent  = `(${state.filteredPromos.length}/${state.promos.length})`;
      document.getElementById("meta").textContent = `${state.issuers.length} issuers · ${state.cards.length} cards · ${state.promos.length} promos`;
    }

    // Collapsible cards: click (or Enter/Space) on the <h2> to toggle
    document.querySelectorAll('.card > h2').forEach(h => {
      h.setAttribute('tabindex', '0'); // keyboard focusable
      const toggle = () => {
        const card = h.closest('.card');
        const isCollapsed = card.getAttribute('data-collapsed') === 'true';
        card.setAttribute('data-collapsed', isCollapsed ? 'false' : 'true');
      };
      h.addEventListener('click', toggle);
      h.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggle();
        }
      });
    });

    document.getElementById('q').addEventListener('input', () => applyFilters());
    document.getElementById('merchant-chips').addEventListener('click', (e)=>{
      const btn = e.target.closest('.chip');
      if(!btn) return;
      const pressed = btn.getAttribute('aria-pressed') === 'true';
      btn.setAttribute('aria-pressed', pressed ? 'false' : 'true');
      applyFilters();
    });
    document.getElementById('merchant-clear').addEventListener('click', () => {
      document.querySelectorAll('#merchant-chips .chip[aria-pressed="true"]').forEach(el => el.setAttribute('aria-pressed','false'));
      applyFilters();
    });

    (async () => {
      try{
        const [issuers, cards, promos] = await Promise.all([
          load("issuer.json"),
          load("card.json"),
          load("promotion.json"),
        ]);
        state.issuers = issuers;
        state.cards   = cards;
        state.promos  = promos;
        state.filteredCards  = cards;
        state.filteredPromos = promos;

        renderTable(document.getElementById('tbl-issuers'), issuers);
        buildMerchantOptions(promos);
        applyFilters();
      }catch(err){
        const wrap = document.querySelector(".wrap");
        const div = document.createElement("div");
        div.className = "muted";
        div.style.cssText = "margin-top:12px;color:#fca5a5";
        div.textContent = `Error loading JSON: ${err.message}`;
        wrap.appendChild(div);
      }
    })();
  </script>
</body>
</html>
