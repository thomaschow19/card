<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JSON Viewer — Issuers / Cards / Promotions</title>
  <style>
    :root{
      --bg: #0b0c0f;
      --card: #12151a;
      --muted: #9aa4b2;
      --text: #e6e9ef;
      --border: #1f2430;
      --accent: #7c9cff;
      --accent-2: #59e1ff;
      --badge-bg: #19202b;
      --badge-br: #2a3342;
      --row: #0f1217;
      --row-alt: #10151c;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f8fb; --card:#ffffff; --muted:#6b7280; --text:#0f172a; --border:#e5e7eb;
        --accent:#3b82f6; --accent-2:#06b6d4; --badge-bg:#f1f5f9; --badge-br:#e2e8f0;
        --row:#ffffff; --row-alt:#fafafa; --shadow:0 8px 24px rgba(2,6,23,0.08);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
      Roboto, "Noto Sans", "PingFang HK", "Hiragino Sans", Arial, sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, rgba(124,156,255,.10), transparent 60%),
                  radial-gradient(1200px 900px at 110% 10%, rgba(89,225,255,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:32px 24px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px
    }
    .title{font-size:22px;font-weight:700;letter-spacing:.2px}
    .muted{color:var(--muted);font-size:12px}
    .search{
      min-width:240px; max-width:420px; flex:1;
      padding:10px 12px; border:1px solid var(--border); border-radius:12px;
      background:linear-gradient(0deg,rgba(255,255,255,.02),rgba(255,255,255,.02)),var(--card);
      color:var(--text); outline:none;
    }
    .seg{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--badge-bg)}
    .seg-btn{padding:8px 12px;border:none;background:transparent;color:var(--muted);cursor:pointer;font-size:12px}
    .seg-btn + .seg-btn{border-left:1px solid var(--border)}
    .seg input[type=radio]{position:absolute;opacity:0;width:0;height:0}
    .seg input[type=radio] + label.seg-btn{user-select:none}
    .seg input[type=radio]:checked + label.seg-btn{
      background:linear-gradient(0deg,rgba(255,255,255,.06),rgba(255,255,255,.06)),var(--card);
      font-weight:600;
      color:var(--text);
    }
    .seg-btn:active{transform:translateY(1px)}
    /* Stronger selected state for segmented radios */
    .seg input[type=radio]:focus + label.seg-btn{outline:none}
    .seg-btn:hover{filter:brightness(1.05)}
    .filters{display:flex;flex-direction:column;gap:10px}
    .filter-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .select{min-width:260px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:linear-gradient(0deg,rgba(255,255,255,.02),rgba(255,255,255,.02)),var(--card);color:var(--text);outline:none}
    .btn-clear{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);cursor:pointer}
    .btn-clear:active{transform:translateY(1px)}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{border:1px solid var(--border);background:var(--card);color:var(--text);padding:6px 10px;border-radius:999px;cursor:pointer;font-size:12px}
    .chip[aria-pressed="true"]{outline:2px solid var(--accent); background:linear-gradient(0deg,rgba(255,255,255,.04),rgba(255,255,255,.04)),var(--card)}
    .chip:active{transform:translateY(1px)}
    .grid{
      display:grid; grid-template-columns:1fr; gap:18px;
    }
    /* @media(min-width:900px){ .grid{ grid-template-columns:1fr 1fr; } } */
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)) , var(--card);
      border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:15px;cursor:pointer;position:relative}
    .card h2::after{content:"▾";position:absolute;right:12px;top:50%;transform:translateY(-50%) rotate(0deg);transition:transform .15s ease-in-out;color:var(--muted)}
    .card[data-collapsed="true"] h2::after{transform:translateY(-50%) rotate(-90deg)}
    /* Hide card body when collapsed */
    .card[data-collapsed="true"] .inner, .card[data-collapsed="true"] .scroll{display:none}
    .card .inner{padding:12px 16px}
    .scroll{max-height:55vh;overflow:auto;border-top:1px solid var(--border)}
    table{width:100%; border-collapse:separate; border-spacing:0; font-size:12.5px}
    thead th{
      position:sticky; top:0; z-index:2; background:var(--card);
      border-bottom:1px solid var(--border); text-align:left; padding:10px 12px;
      font-weight:600;
    }
    tbody td{padding:10px 12px; border-bottom:1px dashed var(--border); vertical-align:top}
    tbody tr:nth-child(odd){background:var(--row)}
    tbody tr:nth-child(even){background:var(--row-alt)}
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
         font-size:12px; padding:.1rem .35rem; border-radius:6px; background:var(--badge-bg); border:1px solid var(--badge-br)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:6px;
          background:var(--badge-bg); border:1px solid var(--badge-br); margin:2px 4px 2px 0}
    .subtle{opacity:.85}
    .footer{margin-top:18px; text-align:right}
    .hint{font-size:12px;color:var(--muted)}
    /* Overlay settings panel */
    .overlay.hidden{display:none}
    .overlay{position:fixed;inset:0;z-index:50}
    .overlay-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
    .overlay-panel{position:relative;max-width:720px;margin:8vh auto;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .overlay-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
    .overlay-header h3{margin:0;font-size:16px}
    .overlay-close{border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:10px;padding:6px 10px;cursor:pointer}
    .overlay-body{padding:14px 16px}
    #settings-form fieldset{border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin:10px 0}
    #settings-form legend{padding:0 6px;font-size:12px;color:var(--muted)}
    #settings-form .row{display:flex;justify-content:space-between;align-items:center;margin:6px 0;gap:10px}
    #settings-form label{font-size:13px}
    .overlay-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:8px}
    /* Card-row tables when in "cards" view (per-card) */
    .card[data-view="cards"] .scroll{ max-height: none; overflow: visible; padding: 16px 14px; }
    .card[data-view="cards"] table{ border-collapse: separate; }
    .card[data-view="cards"] thead{ display:none; }
    .card[data-view="cards"] tbody{ display:block; }
    .card[data-view="cards"] tbody tr{ display:block; width:100%; margin:16px 0; background:var(--row); border:1px solid var(--border); border-radius:14px; overflow:hidden; }
    .card[data-view="cards"] .scroll tbody tr:first-child{ margin-top: 4px; }
    .card[data-view="cards"] .scroll tbody tr:last-child{ margin-bottom: 4px; }
    .card[data-view="cards"] tbody td{ display:flex; align-items:flex-start; gap:8px; padding:12px 14px; border-bottom:1px dashed var(--border); }
    .card[data-view="cards"] tbody td:last-child{ border-bottom:none; }
    .card[data-view="cards"] tbody td::before{ content: attr(data-label); flex: 0 0 40%; max-width: 45%; color:var(--muted); font-weight:600; }
    .card[data-view="cards"] tbody td > *{ flex:1 1 auto; }
    /* Extra-small phones: stack label above value to prevent clipping */
    @media (max-width: 480px){
      .card[data-view="cards"] tbody td{ 
        display:block; 
        padding:12px 14px; 
        word-break:break-word; 
        overflow-wrap:anywhere; 
      }
      .card[data-view="cards"] tbody td::before{
        display:block; 
        margin-bottom:6px; 
        flex:none; 
        max-width:100%;
      }
      .card[data-view="cards"] tbody td > *{ 
        display:block; 
        width:100%; 
      }
      /* Ensure code and long strings wrap nicely on narrow screens */
      code{white-space:pre-wrap;word-break:break-word}
    }
    /* Modern switch for Start collapsed */
    .switch{display:inline-flex;align-items:center;position:relative}
    .switch input{position:absolute;opacity:0;width:0;height:0}
    .switch .switch-ui{width:42px;height:24px;border-radius:999px;background:var(--badge-bg);border:1px solid var(--badge-br);display:inline-block;position:relative;transition:background .2s,border-color .2s}
    .switch .switch-ui::after{content:"";position:absolute;top:50%;left:2px;width:18px;height:18px;border-radius:50%;background:var(--card);border:1px solid var(--border);transform:translateY(-50%);transition:left .2s}
    .switch input:checked + .switch-ui{background:linear-gradient(0deg,rgba(124,156,255,.25),rgba(124,156,255,.25)),var(--badge-bg);border-color:var(--accent)}
    .switch input:checked + .switch-ui::after{left:calc(100% - 20px)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">JSON Viewer</div>
      <input id="q" class="search" placeholder="Search cards & promotions…" />
      <button id="btn-settings" class="btn-clear" type="button" aria-haspopup="dialog" aria-controls="settings-overlay">Settings</button>
    </div>
    <div class="muted" style="margin-bottom:14px">Loads <code>issuer.json</code>, <code>card.json</code>, and <code>promotion.json</code> from this folder.</div>

    <div class="grid">
      <div id="card-issuers" class="card" data-collapsed="true" data-view="cards">
        <h2>Issuers <span id="issuer-count" class="muted"></span></h2>
        <div class="scroll"><table id="tbl-issuers"></table></div>
      </div>

      <div id="card-cards" class="card" data-collapsed="true" data-view="cards">
        <h2>Cards <span id="card-count" class="muted"></span></h2>
        <div class="inner hint">Showing fields as columns; arrays render as badges.</div>
        <div class="scroll"><table id="tbl-cards"></table></div>
      </div>

      <div id="card-promos" class="card" data-view="cards">
        <h2>Promotions <span id="promo-count" class="muted"></span></h2>
        <div class="inner filters">
          <div class="filter-row">
            <label class="muted">Merchant type:</label>
            <div id="merchant-chips" class="chips"></div>
          </div>
          <div class="filter-row">
            <label class="muted">Eligible Currency:</label>
            <div id="currency-chips" class="chips"></div>
          </div>
          <div class="filter-row">
            <button id="merchant-clear" class="btn-clear" type="button">Clear</button>
            <span class="hint">Tap chips to toggle</span>
          </div>
        </div>
        <div class="inner hint">Quick filter above searches across text in both tables.</div>
        <div class="scroll"><table id="tbl-promos"></table></div>
      </div>
    </div>

    <div id="settings-overlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="settings-title">
      <div class="overlay-backdrop" data-close></div>
      <div class="overlay-panel">
        <div class="overlay-header">
          <h3 id="settings-title">Table Settings</h3>
          <button class="overlay-close" type="button" data-close aria-label="Close">×</button>
        </div>
        <div class="overlay-body">
          <form id="settings-form">
            <fieldset>
              <legend>Issuers</legend>
              <label class="row"><span>View</span>
                <div class="seg">
                  <input type="radio" id="issuers-view-cards" name="issuers-view" value="cards">
                  <label class="seg-btn" for="issuers-view-cards">Card view</label>
                  <input type="radio" id="issuers-view-table" name="issuers-view" value="table">
                  <label class="seg-btn" for="issuers-view-table">Table view</label>
                </div>
              </label>
              <label class="row"><span>Start collapsed</span>
                <label class="switch"><input type="checkbox" name="issuers-collapsed"><span class="switch-ui"></span></label>
              </label>
            </fieldset>
            <fieldset>
              <legend>Cards</legend>
              <label class="row"><span>View</span>
                <div class="seg">
                  <input type="radio" id="cards-view-cards" name="cards-view" value="cards">
                  <label class="seg-btn" for="cards-view-cards">Card view</label>
                  <input type="radio" id="cards-view-table" name="cards-view" value="table">
                  <label class="seg-btn" for="cards-view-table">Table view</label>
                </div>
              </label>
              <label class="row"><span>Start collapsed</span>
                <label class="switch"><input type="checkbox" name="cards-collapsed"><span class="switch-ui"></span></label>
              </label>
            </fieldset>
            <fieldset>
              <legend>Promotions</legend>
              <label class="row"><span>View</span>
                <div class="seg">
                  <input type="radio" id="promos-view-cards" name="promos-view" value="cards">
                  <label class="seg-btn" for="promos-view-cards">Card view</label>
                  <input type="radio" id="promos-view-table" name="promos-view" value="table">
                  <label class="seg-btn" for="promos-view-table">Table view</label>
                </div>
              </label>
              <label class="row"><span>Start collapsed</span>
                <label class="switch"><input type="checkbox" name="promos-collapsed"><span class="switch-ui"></span></label>
              </label>
            </fieldset>
            <div class="overlay-actions">
              <button type="button" class="btn-clear" data-close>Cancel</button>
              <button type="submit" class="btn-clear">Apply</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="footer muted" id="meta"></div>
  </div>

  <script>
    // Settings overlay logic + persistence
    const overlay = document.getElementById('settings-overlay');
    const form = document.getElementById('settings-form');
    function openSettings(){ overlay.classList.remove('hidden'); }
    function closeSettings(){ overlay.classList.add('hidden'); }
    function loadPersisted(){
      return {
        view: {
          issuers: localStorage.getItem('view.issuers') || null,
          cards:   localStorage.getItem('view.cards')   || null,
          promos:  localStorage.getItem('view.promos')  || null,
          global:  localStorage.getItem('view.global')  || 'cards'
        },
        collapsed: {
          issuers: localStorage.getItem('collapsed.issuers'),
          cards:   localStorage.getItem('collapsed.cards'),
          promos:  localStorage.getItem('collapsed.promos')
        }
      };
    }
    function applyPersisted(p){
      const issuers = document.getElementById('card-issuers');
      const cards   = document.getElementById('card-cards');
      const promos  = document.getElementById('card-promos');
      const gv = p.view.global || 'cards';
      issuers.setAttribute('data-view', p.view.issuers || gv);
      cards.setAttribute('data-view',   p.view.cards   || gv);
      promos.setAttribute('data-view',  p.view.promos  || gv);
      if(p.collapsed.issuers !== null) issuers.setAttribute('data-collapsed', p.collapsed.issuers === 'true' ? 'true':'false');
      if(p.collapsed.cards   !== null) cards.setAttribute('data-collapsed',   p.collapsed.cards   === 'true' ? 'true':'false');
      if(p.collapsed.promos  !== null) promos.setAttribute('data-collapsed',  p.collapsed.promos  === 'true' ? 'true':'false');
    }
    function syncSettingsForm(){
      const issuers = document.getElementById('card-issuers');
      const cards   = document.getElementById('card-cards');
      const promos  = document.getElementById('card-promos');
      const iv = issuers.getAttribute('data-view') || 'cards';
      const cv = cards.getAttribute('data-view')   || 'cards';
      const pv = promos.getAttribute('data-view')  || 'cards';
      form.querySelectorAll('input[name="issuers-view"]').forEach(r=> r.checked = (r.value === iv));
      form.querySelectorAll('input[name="cards-view"]').forEach(r  => r.checked = (r.value === cv));
      form.querySelectorAll('input[name="promos-view"]').forEach(r => r.checked = (r.value === pv));
      form.elements['issuers-collapsed'].checked = (issuers.getAttribute('data-collapsed') === 'true');
      form.elements['cards-collapsed'].checked   = (cards.getAttribute('data-collapsed')   === 'true');
      form.elements['promos-collapsed'].checked  = (promos.getAttribute('data-collapsed')  === 'true');
    }
    function persistFromForm(){
      const iv = form.querySelector('input[name="issuers-view"]:checked').value;
      const cv = form.querySelector('input[name="cards-view"]:checked').value;
      const pv = form.querySelector('input[name="promos-view"]:checked').value;
      localStorage.setItem('view.issuers', iv);
      localStorage.setItem('view.cards',   cv);
      localStorage.setItem('view.promos',  pv);
      localStorage.setItem('collapsed.issuers', String(form.elements['issuers-collapsed'].checked));
      localStorage.setItem('collapsed.cards',   String(form.elements['cards-collapsed'].checked));
      localStorage.setItem('collapsed.promos',  String(form.elements['promos-collapsed'].checked));
    }
    document.getElementById('btn-settings').addEventListener('click', ()=>{ syncSettingsForm(); openSettings(); });
    overlay.addEventListener('click', (e)=>{ if(e.target.hasAttribute('data-close')) closeSettings(); });
    document.getElementById('settings-form').addEventListener('submit', (e)=>{
      e.preventDefault();
      persistFromForm();
      applyPersisted(loadPersisted());
      closeSettings();
    });
    // Apply persisted settings on first load
    applyPersisted(loadPersisted());

    const state = { issuers: [], cards: [], promos: [], filteredCards: [], filteredPromos: [] };
    let cardIdToName = new Map();

    async function load(path){
      const res = await fetch(path, { cache: "no-store" });
      if(!res.ok) throw new Error(`${path}: ${res.status} ${res.statusText}`);
      return res.json();
    }

    function caps(s){ return (s||"").charAt(0).toUpperCase() + (s||"").slice(1); }

    function valueToHTML(v){
      if (v == null) return "";
      if (Array.isArray(v)) {
        if (v.length === 0) return "";
        return v.map(x => `<span class="pill">${escapeHTML(String(x))}</span>`).join("");
      }
      if (typeof v === "object") return `<code>${escapeHTML(JSON.stringify(v))}</code>`;
      const s = String(v);
      // highlight IDs like ABC1234
      if (/^[A-Z0-9]{6,}$/.test(s)) return `<code>${escapeHTML(s)}</code>`;
      return escapeHTML(s);
    }

    function normalizeType(s){
      return String(s||"").toLowerCase().replace(/\s+/g, "");
    }
    function isAnySpendingLabel(s){
      const t = normalizeType(s);
      return t.includes("anyspending") || t.includes("任何消費");
    }
    function promoHasAnySpending(p){
      const arr = Array.isArray(p.merchantType) ? p.merchantType : [];
      return arr.some(isAnySpendingLabel);
    }

    function isEmptyValue(v){
      if (v === null || v === undefined) return true;
      if (typeof v === 'string') return v.trim() === '';
      if (Array.isArray(v)) return v.length === 0 || v.every(isEmptyValue);
      if (typeof v === 'object') return Object.keys(v).length === 0; // treat empty object as empty
      // numbers and booleans are considered meaningful even if 0/false
      return false;
    }

    function renderTable(el, rows){
      if (!rows || rows.length === 0) {
        el.innerHTML = "<tbody><tr><td class='subtle'>No data</td></tr></tbody>";
        return;
      }
      // Collect columns across all rows for stability
      let cols = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
      // Hide certain columns per table
      if (el.id === 'tbl-promos') {
        cols = cols.filter(c => c !== 'promotionID');
      }
      // Hide columns where every displayed row has an empty value
      cols = cols.filter(c => rows.some(r => !isEmptyValue(r[c])));
      // If everything got filtered out, show a minimal message
      if (cols.length === 0){
        el.innerHTML = "<tbody><tr><td class='subtle'>No non-empty fields</td></tr></tbody>";
        return;
      }
      const thead = "<thead><tr>" + cols.map(c => `<th>${escapeHTML(caps(c))}</th>`).join("") + "</tr></thead>";
      const tbody = "<tbody>" + rows.map(r => {
        return "<tr>" + cols.map(c => {
          let v = r[c];
          if (el.id === 'tbl-promos' && c === 'eligibleCards' && Array.isArray(v)) {
            v = v.map(id => cardIdToName.get(String(id)) || id);
          }
          const label = escapeHTML(caps(c));
          return `<td data-label="${label}">${valueToHTML(v)}</td>`;
        }).join("") + "</tr>";
      }).join("") + "</tbody>";
      el.innerHTML = thead + tbody;
    }

    const HTML_ESC = {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
    function escapeHTML(s){
      return s.replace(/[&<>"']/g, ch => HTML_ESC[ch]);
    }

    function buildMerchantOptions(promos){
      const all = new Set();
      promos.forEach(p => {
        (Array.isArray(p.merchantType) ? p.merchantType : []).forEach(mt => {
          const key = mt && String(mt).trim();
          if(key) all.add(key);
        });
      });
      const list = Array.from(all).sort((a,b)=>String(a).localeCompare(String(b)));
      const box = document.getElementById('merchant-chips');
      box.innerHTML = '';
      list.forEach(txt => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'chip';
        btn.setAttribute('aria-pressed', 'false');
        btn.dataset.value = txt;
        btn.textContent = txt;
        box.appendChild(btn);
      });
    }
    function getSelectedMerchantTypes(){
      return Array.from(document.querySelectorAll('#merchant-chips .chip[aria-pressed="true"]')).map(el => el.dataset.value);
    }

    function normalizeCurrency(s){
      // Keep original casing; only trim whitespace
      return String(s||"").trim();
    }
    // Build chips for Eligible Currency only (ignore category)
    function buildEligibleCurrencyOptions(promos){
      const all = new Set();
      (Array.isArray(promos) ? promos : []).forEach(p => {
        const ec = Array.isArray(p.eligibleCurrency) ? p.eligibleCurrency : [];
        ec.forEach(c => { const v = normalizeCurrency(c); if(v) all.add(v); });
      });
      const list = Array.from(all).sort();
      const box = document.getElementById('currency-chips');
      box.innerHTML = '';
      list.forEach(txt => {
        const btn = document.createElement('button');
        btn.type = 'button'; btn.className = 'chip';
        btn.setAttribute('aria-pressed','false');
        btn.dataset.value = txt; btn.textContent = txt;
        box.appendChild(btn);
      });
    }
    function getSelectedEligibleCurrencies(){
      return Array.from(document.querySelectorAll('#currency-chips .chip[aria-pressed="true"]')).map(el => el.dataset.value);
    }

    function applyFilters(){
      const s = (document.getElementById('q').value || '').trim().toLowerCase();
      const chosen = getSelectedMerchantTypes().map(normalizeType);

      // Cards filter (text only)
      state.filteredCards = !s ? state.cards : state.cards.filter(r => JSON.stringify(r).toLowerCase().includes(s));

      // Promotions filter (text + merchant types)
      let base = !s ? state.promos : state.promos.filter(r => JSON.stringify(r).toLowerCase().includes(s));

      if(chosen.length){
        base = base.filter(p => {
          if (promoHasAnySpending(p)) return true; // Any Spending matches all
          const types = (Array.isArray(p.merchantType) ? p.merchantType : []).map(normalizeType);
          return chosen.some(c => types.includes(c));
        });
      }

      // EligibleCurrency filter only (ignore designatedForeignCurrency)
      const pickedCurrencies = getSelectedEligibleCurrencies().map(normalizeCurrency);
      if (pickedCurrencies.length){
        base = base.filter(p => {
          const ec = (Array.isArray(p.eligibleCurrency) ? p.eligibleCurrency : []).map(normalizeCurrency);
          if (ec.length === 0) return false;
          const set = new Set(ec);
          return pickedCurrencies.some(c => set.has(c));
        });
      }

      base.sort((a,b)=> (Number(b.rebatePercentageCashback)||0) - (Number(a.rebatePercentageCashback)||0));

      state.filteredPromos = base;
      renderTable(document.getElementById('tbl-cards'), state.filteredCards);
      renderTable(document.getElementById('tbl-promos'), state.filteredPromos);
      setCounts();
    }

    function setCounts(){
      document.getElementById("issuer-count").textContent = `(${state.issuers.length})`;
      document.getElementById("card-count").textContent   = `(${state.filteredCards.length}/${state.cards.length})`;
      document.getElementById("promo-count").textContent  = `(${state.filteredPromos.length}/${state.promos.length})`;
      document.getElementById("meta").textContent = `${state.issuers.length} issuers · ${state.cards.length} cards · ${state.promos.length} promos`;
    }

    // Collapsible cards: click (or Enter/Space) on the <h2> to toggle
    document.querySelectorAll('.card > h2').forEach(h => {
      h.setAttribute('tabindex', '0'); // keyboard focusable
      const toggle = () => {
        const card = h.closest('.card');
        const isCollapsed = card.getAttribute('data-collapsed') === 'true';
        card.setAttribute('data-collapsed', isCollapsed ? 'false' : 'true');
      };
      h.addEventListener('click', toggle);
      h.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggle();
        }
      });
    });

    document.getElementById('q').addEventListener('input', () => applyFilters());
    document.getElementById('merchant-chips').addEventListener('click', (e)=>{
      const btn = e.target.closest('.chip');
      if(!btn) return;
      const pressed = btn.getAttribute('aria-pressed') === 'true';
      btn.setAttribute('aria-pressed', pressed ? 'false' : 'true');
      applyFilters();
    });
    document.getElementById('currency-chips').addEventListener('click', (e)=>{
      const btn = e.target.closest('.chip');
      if(!btn) return;
      const pressed = btn.getAttribute('aria-pressed') === 'true';
      btn.setAttribute('aria-pressed', pressed ? 'false' : 'true');
      applyFilters();
    });
    document.getElementById('merchant-clear').addEventListener('click', () => {
      document.querySelectorAll('#merchant-chips .chip[aria-pressed="true"]').forEach(el => el.setAttribute('aria-pressed','false'));
      document.querySelectorAll('#currency-chips .chip[aria-pressed="true"]').forEach(el => el.setAttribute('aria-pressed','false'));
      applyFilters();
    });

    (async () => {
      try{
        const [issuers, cards, promos] = await Promise.all([
          load("issuer.json"),
          load("card.json"),
          load("promotion.json"),
        ]);
        state.issuers = issuers;
        state.cards   = cards;
        cardIdToName = new Map();
        (Array.isArray(cards) ? cards : []).forEach(c => {
          if (c && c.cardID && c.cardName) {
            cardIdToName.set(String(c.cardID), String(c.cardName));
          }
        });
        state.promos  = promos;
        state.filteredCards  = cards;
        state.filteredPromos = promos;

        renderTable(document.getElementById('tbl-issuers'), issuers);
        buildMerchantOptions(promos);
        buildEligibleCurrencyOptions(promos);
        applyFilters();
      }catch(err){
        const wrap = document.querySelector(".wrap");
        const div = document.createElement("div");
        div.className = "muted";
        div.style.cssText = "margin-top:12px;color:#fca5a5";
        div.textContent = `Error loading JSON: ${err.message}`;
        wrap.appendChild(div);
      }
    })();
  </script>
</body>
</html>
